var bgVbo;var bgProgram;var bgMvp;var BG_SIZE=512;function bgInit(){var b=new Float32Array([0,0,0,0,BG_SIZE,0,1,0,0,BG_SIZE,0,1,BG_SIZE,BG_SIZE,1,1,]);bgVbo=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,bgVbo);gl.bufferData(gl.ARRAY_BUFFER,b,gl.STATIC_DRAW);bgProgram=new esProgram(gl);bgProgram.addShaderId("bg-fs",ES_FRAGMENT);bgProgram.addShaderId("bg-vs",ES_VERTEX);bgProgram.bindAttribute(0,"pos");bgProgram.link();bgProgram.use();var a=bgProgram.getUniform("mvp");var c=bgProgram.getUniform("tex");bgMvp=esMat4_create();esMat4_ortho(bgMvp,0,512,512,0);gl.uniformMatrix4fv(a,false,bgMvp);gl.uniform1i(c,0)}function bgRenderPre(){bgProgram.use();gl.bindTexture(gl.TEXTURE_2D,texBg);gl.enableVertexAttribArray(0);gl.bindBuffer(gl.ARRAY_BUFFER,bgVbo);gl.vertexAttribPointer(0,4,gl.FLOAT,false,0,0);gl.drawArrays(gl.TRIANGLE_STRIP,0,4);gl.disableVertexAttribArray(0)}function bgRenderPost(){spriteAdd(95,63,32,SP_BRUSH0);spriteAdd(130,69,32,SP_BRUSH0)}var gl;var imgBg;var imgSprites;var imgCsKnife;var imgCsRedWin;var imgCsRedKill;var texBg;var texSprites;var texCsKnife;var texCsRedWin;var texCsRedKill;var frameFunc;var blockMouse;function frameExec(a){if(a>0.3){return}gl.clear(gl.COLOR_BUFFER_BIT);if(frameFunc!=null){frameFunc(a)}spriteFlush()}function makeTexture(b){var a=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,a);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,b);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);assert(a!=null,a);return a}function loaded(){texBg=makeTexture(imgBg);texSprites=makeTexture(imgSprites);texCsKnife=makeTexture(imgCsKnife);texCsRedWin=makeTexture(imgCsRedWin);texCsRedKill=makeTexture(imgCsRedKill);bgInit();spriteInit();nodeInit();aiInit();avatarInit();deathInit();var a=document.getElementById("can");a.addEventListener("mousedown",mouseEvent,false);esNextFrame(frameExec);modePlay()}function main(){frameFunc=null;gl=esInitGl("can");gl.clearColor(0,0,0,1);gl.clear(gl.COLOR_BUFFER_BIT);var a=new esLoad();imgBg=a.loadImage("bg.png");imgSprites=a.loadImage("sprites.png");imgCsKnife=a.loadImage("cs_knife.png");imgCsRedWin=a.loadImage("cs_redwin.png");imgCsRedKill=a.loadImage("cs_redkill.png");a.download(loaded)}function mouseEvent(d){if(blockMouse){return}var b=document.getElementById("can");var c=b.getBoundingClientRect();var a=d.clientX-(c.x|c.left);var e=d.clientY-(c.y|c.top);avatarSetMouse(a,e)}function modePlay(){blockMouse=false;frameFunc=playFrame}function modeDeath(){blockMouse=true;frameFunc=deathFrame}function assert(a,b){if(!a){alert(b);throw new Error(a,b)}}var avatarWalker;var avatarLastWalkerState;var avatarState;var avatarQueueMouse;var avatarActionX;var avatarActionY;var avatarActionSprite;var avatarAction;var avatarNodeAt;var avatarNodeTravelA;var avatarNodeTravelB;var avatarWeapon;var AV_WAITING=1;var AV_WALKING=2;var WE_NONE=0;var WE_KNIFE=1;var WE_TEXT=["no weapon","knife"];function avatarInit(a){avatarWalker=new NodeWalker(nodePlayerStart,35);avatarLastWalkerState=-1;avatarWeapon=WE_NONE}function avatarFrame(a){if(avatarQueueMouse){avatarMouse()}avatarWalker.frame(a);if(avatarLastWalkerState!=avatarWalker.state){avatarLastWalkerState=avatarWalker.state;avatarUpdateState()}if(!avatarWalker.hidden){if(avatarAction){spriteAdd(avatarActionX,avatarActionY,32,SP_TABLET);spriteAdd(avatarActionX,avatarActionY,32,avatarActionSprite);switch(avatarAction){case ACTION_HIDE_ATTACK:break;default:case ACTION_TELEPORT:spriteAdd(avatarWalker.x,avatarWalker.y,32,SP_PLAYER_SNEAK);break;case ACTION_PICK_KNIFE:spriteAdd(avatarWalker.x,avatarWalker.y,32,SP_PLAYER_IDLE);break}}else{if(avatarState==AV_WALKING){spriteAdd(avatarWalker.x,avatarWalker.y,32,spriteFrame(SP_PLAYER,avatarWalker))}else{if(avatarState==AV_WAITING){spriteAdd(avatarWalker.x,avatarWalker.y,32,SP_PLAYER_IDLE)}}}}spriteAddText(12,500,16,WE_TEXT[avatarWeapon])}function avatarSetMouse(a,b){avatarQueueMouse=[a,b];avatarMouse()}function avatarMouse(){if(avatarState==AV_WAITING){var a=avatarQueueMouse[0];var d=avatarQueueMouse[1];avatarQueueMouse=null;if(avatarAction!=ACTION_NONE&&avatarOnAction(a,d)){switch(avatarAction){case ACTION_PICK_KNIFE:avatarWeapon=WE_KNIFE;break;case ACTION_HIDE_ATTACK:var c=avatarWalker.from.rebase;var b=aiAttack(c.x,c.y,avatarWeapon);avatarWalker.goAction(avatarAction,b);break;default:avatarWalker.goAction(avatarAction)}}else{avatarDirMove(a,d)}}}function avatarUpdateActions(a){avatarAction=a;avatarActionX=avatarWalker.x;avatarActionY=avatarWalker.y+40;switch(a){case ACTION_HIDE:avatarActionSprite=SP_ICON_HIDE;break;case ACTION_HIDE_ATTACK:avatarActionSprite=SP_ICON_HIDE_ATTACK;break;case ACTION_TELEPORT:avatarActionSprite=SP_ICON_TELEPORT;break;case ACTION_PICK_KNIFE:avatarActionSprite=SP_ICON_KNIFE;break}}function avatarUpdateState(){switch(avatarWalker.state){case NW_IDLE:avatarWalker.from.occupied=true;avatarState=AV_WAITING;avatarNodeAt=avatarWalker.from;avatarNodeTravelA=avatarNodeTravelB=null;if(avatarQueueMouse!=null){avatarMouse()}avatarUpdateActions(avatarWalker.from.action);break;case NW_WALKING:avatarWalker.from.occupied=false;avatarState=AV_WALKING;avatarNodeAt=null;avatarNodeTravelA=avatarWalker.from;avatarNodeTravelB=avatarWalker.dest;avatarUpdateActions(0);break}}function avatarDirMove(a,f){var c=avatarWalker.x-a;var b=avatarWalker.y-f;var e=Math.abs(c);var d=Math.abs(b);if(e<16&&d<16){return}if(e>=d){if(c>0){avatarWalker.goEast()}else{avatarWalker.goWest()}}else{if(b>0){avatarWalker.goNorth()}else{avatarWalker.goSouth()}}}function avatarOnAction(a,d){var c=Math.abs(a-avatarActionX);var b=Math.abs(d-avatarActionY);return c<16&&b<16}var aiList;var aiWave=0;var AI_RAND=16;var CAUGHT_RAD=16;var AIMSG_RED_WIN;var AIMSG_RED_LOSE;function aiInit(){AIMSG_RED_WIN=[texCsRedWin,"you got caught",null];AIMSG_RED_LOSE=[texCsRedKill,"take that",null];aiWave=0;aiRespawnWave()}function aiFrame(b){for(var a=0;a<aiList.length;a++){aiList[a].frame(b)}}function aiRespawnWave(){aiList=[];switch(aiWave){case 0:spawnRed();spawnRed();spawnRed();break}}function spawnRed(){aiList.push(new Ai(nodeAiStart0,SP_AI_RED,AIMSG_RED_WIN,AIMSG_RED_LOSE,WE_KNIFE))}function aiAttack(a,d,c){for(var b=0;b<aiList.length;b++){if(aiList[b].caught(a,d)){switch(c){default:case WE_NONE:break;case WE_KNIFE:deathQueue(texCsKnife,"thrust",1,null);break}if(aiList[b].voln==c){deathQueue(aiList[b].killMsg[0],aiList[b].killMsg[1],1,aiList[b].killMsg[2]);aiList.splice(b,1);modeDeath();return true}else{aiList[b].attack=true;aiList[b].speed=aiList[b].orgSpeed*3}}}return false}function Ai(d,e,c,b,a){this.attack=false;this.voln=a;this.orgSpeed=20+Math.random()*15;this.walker=new NodeWalker(d,this.orgSpeed);this.offsetX=(Math.random()-0.5)*AI_RAND;this.offsetY=(Math.random()-0.5)*AI_RAND;this.walker.goRandom();this.spriteBase=e;this.winMsg=c;this.killMsg=b}Ai.prototype.frame=function(d){if(this.walker.state==NW_IDLE){this.planTravel()}this.walker.frame(d);var b=this.walker.animation+this.walker.animationBase;var a=[this.spriteBase[0]+b,this.spriteBase[1]];var c=this.walker.animation;spriteAdd(Math.floor(this.walker.x+this.offsetX),Math.floor(this.walker.y+this.offsetY)+c,24,a);if(this.attack&&this.caughtPlayer()){deathQueue(this.winMsg[0],this.winMsg[1],3,this.winMsg[2]);modeDeath();deathReborn()}};Ai.prototype.planTravel=function(){if(this.isSeePlayer()){this.walker.speed=this.orgSpeed*2;this.attack=true;var a=avatarNodeAt;if(a==null){a=avatarNodeTravelB}this.walker.travel(a)}else{this.walker.speed=this.orgSpeed;this.attack=false;this.walker.goRandom()}};Ai.prototype.caught=function(a,d){var c=Math.abs(this.walker.x-a);var b=Math.abs(this.walker.y-d);return c<CAUGHT_RAD&&b<CAUGHT_RAD};Ai.prototype.caughtPlayer=function(){if(avatarWalker.hidden){return false}return this.caught(avatarWalker.x,avatarWalker.y)};Ai.prototype.isSeePlayer=function(){if(this.walker.from.equals(avatarNodeAt)){return true}if(isAvatarTravel(this.walker.from,this.walker.from.west)){return true}if(isAvatarTravel(this.walker.from,this.walker.from.east)){return true}if(isAvatarTravel(this.walker.from,this.walker.from.north)){return true}if(isAvatarTravel(this.walker.from,this.walker.from.south)){return true}return false};function isAvatarTravel(d,c){if(c==null){return false}if(d.equals(avatarNodeTravelA)&&c.equals(avatarNodeTravelB)){return true}if(d.equals(avatarNodeTravelB)&&c.equals(avatarNodeTravelA)){return true}if(avatarNodeAt!=null&&avatarNodeAt.equals(c)){return true}return false}var spriteList;var spriteCount;var spriteVbo;var spriteProgram;var SPRITE_MAX=100;var SPRITE_COMPS=5;var SPRITE_COMPS_SIZE=SPRITE_COMPS*4;var SPRITE_DIM=16;var SP_NODE=[0,0];var SP_CROSS=[1,0];var SP_BOX_FREE=[1,0];var SP_BOX_TAKEN=[2,0];var SP_PLAYER_IDLE=[8,1];var SP_PLAYER_SNEAK=[9,1];var SP_TABLET=[3,0];var SP_ICON_HIDE=[4,0];var SP_ICON_HIDE_ATTACK=[5,0];var SP_ICON_TELEPORT=[6,0];var SP_ICON_KNIFE=[7,0];var SP_BRUSH0=[0,11];var SP_PLAYER=[0,1];var SP_AI_RED=[0,2];function spriteInit(){spriteCount=0;spriteList=new Float32Array(SPRITE_MAX*SPRITE_COMPS);spriteList[0]=0.5;spriteVbo=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,spriteVbo);gl.bufferData(gl.ARRAY_BUFFER,spriteList,gl.DYNAMIC_DRAW);spriteProgram=new esProgram(gl);spriteProgram.addShaderId("sprite-fs",ES_FRAGMENT);spriteProgram.addShaderId("sprite-vs",ES_VERTEX);spriteProgram.bindAttribute(0,"pos");spriteProgram.bindAttribute(1,"uv");spriteProgram.bindAttribute(2,"size");spriteProgram.link();spriteProgram.use();var b=spriteProgram.getUniform("tex");var a=spriteProgram.getUniform("mvp");gl.uniform1i(b,0);gl.uniformMatrix4fv(a,false,bgMvp)}function spriteAdd(a,e,c,b){if(spriteCount>=SPRITE_MAX){return}var d=SPRITE_COMPS*spriteCount;spriteList[d+0]=a;spriteList[d+1]=e;spriteList[d+2]=b[0];spriteList[d+3]=b[1];spriteList[d+4]=c;spriteCount++}function spriteAddText(g,f,j,h){var e="a".charCodeAt(0);var d="q".charCodeAt(0);for(var c=0;c<h.length;c++){var b=h.charCodeAt(c);var a=b-e;if(a>=0&&a<16){spriteAdd(g,f,j,[a,14])}var a=b-d;if(a>=0&&a<16){spriteAdd(g,f,j,[a,15])}g+=j}}function spriteFlush(){if(spriteCount<=0){return}gl.bindBuffer(gl.ARRAY_BUFFER,spriteVbo);gl.bufferSubData(gl.ARRAY_BUFFER,0,spriteList.subarray(0,spriteCount*SPRITE_COMPS));spriteProgram.use();gl.bindTexture(gl.TEXTURE_2D,texSprites);gl.enableVertexAttribArray(0);gl.enableVertexAttribArray(1);gl.enableVertexAttribArray(2);gl.vertexAttribPointer(0,2,gl.FLOAT,false,SPRITE_COMPS_SIZE,0);gl.vertexAttribPointer(1,2,gl.FLOAT,false,SPRITE_COMPS_SIZE,8);gl.vertexAttribPointer(2,1,gl.FLOAT,false,SPRITE_COMPS_SIZE,16);gl.drawArrays(gl.POINTS,0,spriteCount);gl.disableVertexAttribArray(0);gl.disableVertexAttribArray(1);gl.disableVertexAttribArray(2);spriteCount=0}function spriteFrame(b,c){var a=b[0]+c.animationBase+c.animation;return[a,b[1]]}var nodeList;var NW_IDLE=0;var NW_WALKING=1;var ACTION_NONE=0;var ACTION_HIDE=1;var ACTION_HIDE_ATTACK=2;var ACTION_TELEPORT=3;var ACTION_PICK_KNIFE=4;var nodeAiStart0;var nodePlayerStart;function nodeInit(){nodeList=[];var d=packNode(67,49,ACTION_TELEPORT);var c=packNode(215,53);var b=packNode(62,161);var a=packNode(218,153);var i=packNode(153,48,ACTION_HIDE);var g=packNode(153,31,ACTION_HIDE_ATTACK);var o=packNode(293,148);var n=packNode(346,150,ACTION_PICK_KNIFE);var m=packNode(293,86,ACTION_TELEPORT);var l=packNode(350,207);var k=packNode(465,210);var j=packNode(347,324);var f=packNode(408,330,ACTION_HIDE);var e=packNode(404,314,ACTION_HIDE_ATTACK);var h=packNode(462,331);d.linkWest(i);i.linkWest(c);i.linkHide(g);d.linkSouth(b);b.linkWest(a);c.linkSouth(a);a.linkWest(o);m.linkSouth(o);o.linkWest(n);n.linkSouth(l);l.linkWest(k);l.linkSouth(j);j.linkWest(f);f.linkHide(e);f.linkWest(h);k.linkSouth(h);m.linkTeleport(d);d.linkTeleport(m);nodeAiStart0=c;nodePlayerStart=k}function nodeRender(){for(var a=0;a<nodeList.length;a++){nodeList[a].render()}}function packNode(a,d,c){var b=new Node(a,d,!c?0:c);nodeList.push(b);return b}function NodeWalker(b,a){this.speed=a;this.x=b.x;this.y=b.y;this.from=b;this.dest=null;this.last=null;this.state=NW_IDLE;this.travelDist=0;this.travelDirX=0;this.travelDirY=0;this.travelSpeed=0;this.hidden=false;this.animationBase=0;this.animation=0}NodeWalker.prototype.frame=function(a){switch(this.state){case NW_WALKING:this.travelDist-=a*this.travelSpeed;this.x+=this.travelDirX*a*this.travelSpeed;this.y+=this.travelDirY*a*this.travelSpeed;this.animation=((Math.floor(this.travelDist)>>4)&1);if(this.travelDist<=0){this.x=this.dest.x;this.y=this.dest.y;this.state=NW_IDLE;this.travelDist=0;this.from=this.dest;this.dest=null;this.hidden=false}break}};NodeWalker.prototype.travel=function(f,e){var b=this.from.x-f.x;var a=this.from.y-f.y;var d=Math.abs(b);var c=Math.abs(a);if(d>c){if(b>0){this.animationBase=0}else{this.animationBase=2}}else{if(a>0){this.animationBase=6}else{this.animationBase=4}}this.dest=f;this.state=NW_WALKING;this.last=this.from;var b=f.x-this.from.x;var a=f.y-this.from.y;this.travelDist=Math.sqrt(b*b+a*a);this.travelDirX=b/this.travelDist;this.travelDirY=a/this.travelDist;this.travelSpeed=this.speed;if(e>0){this.travelSpeed*=e}};function shouldGo(c,a,b){if(a!=null&&(c.last==null||!a.equals(c.last))){b.push(a)}}Node.prototype.equals=function(a){if(a==null||this==null){return false}return this.x==a.x&&this.y==a.y};NodeWalker.prototype.goRandom=function(){var a=[];shouldGo(this,this.from.west,a);shouldGo(this,this.from.east,a);shouldGo(this,this.from.south,a);shouldGo(this,this.from.north,a);if(a.length<=0){if(this.from.west!=null){a.push(this.from.west)}if(this.from.east!=null){a.push(this.from.east)}if(this.from.south!=null){a.push(this.from.south)}if(this.from.north!=null){a.push(this.from.north)}}this.travel(a[Math.floor(Math.random()*a.length)])};function goConditional(b,a){if(a!=null){b.travel(a)}else{if(b.from.rebase!=null){b.travel(b.from.rebase)}}}NodeWalker.prototype.goWest=function(){goConditional(this,this.from.west)};NodeWalker.prototype.goEast=function(){goConditional(this,this.from.east)};NodeWalker.prototype.goSouth=function(){goConditional(this,this.from.south)};NodeWalker.prototype.goNorth=function(){goConditional(this,this.from.north)};NodeWalker.prototype.goAction=function(b,a){switch(b){case ACTION_HIDE:this.hidden=a==true;this.travel(this.from.hide,this.hidden?5:1);break;case ACTION_TELEPORT:this.hidden=true;this.travel(this.from.teleport,5);break;default:this.hidden=false||a==true;this.travel(this.from.rebase);break}};function Node(a,c,b){this.x=a;this.y=c;this.action=b;this.occupied=false;this.east=this.west=this.north=this.south=null;this.rebase=this.hide=this.teleport=null}Node.prototype.renderSprite=function(a){spriteAdd(this.x,this.y,32,a)};Node.prototype.render=function(){switch(this.action){case ACTION_HIDE_ATTACK:this.renderSprite(this.occupied?SP_BOX_TAKEN:SP_BOX_FREE);break;default:}};Node.prototype.linkWest=function(a){this.west=a;a.east=this};Node.prototype.linkSouth=function(a){this.south=a;a.north=this};Node.prototype.linkHide=function(a){this.hide=a;a.rebase=this};Node.prototype.linkTeleport=function(a){this.teleport=a};var deathQ;var deathTexture;var deathText;var deathDuration;var deathProgram;var deathVbo;var deathUniTex;function deathInit(){deathQ=[];deathDuration=0;var a=new Float32Array([0,0,0,1,1,0,1,1,0,1,0,0,1,1,1,0]);deathVbo=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,deathVbo);gl.bufferData(gl.ARRAY_BUFFER,a,gl.STATIC_DRAW);deathProgram=new esProgram(gl);deathProgram.addShaderId("death-fs",ES_FRAGMENT);deathProgram.addShaderId("death-vs",ES_VERTEX);deathProgram.bindAttribute(0,"pos");deathProgram.link();deathProgram.use();deathUniTex=deathProgram.getUniform("tex");gl.uniform1i(deathUniTex,0)}function deathReborn(){avatarInit(nodePlayerStart);aiRespawnWave()}function deathQueue(a,d,c,b){deathQ.push([a,d,c])}function deathFrame(d){if(deathDuration<=0){if(deathQ.length<=0){modePlay()}else{var a=deathQ.shift();deathTexture=a[0];deathText=a[1];deathDuration=a[2];var c=a[3]}}deathProgram.use();gl.bindTexture(gl.TEXTURE_2D,deathTexture);gl.enableVertexAttribArray(0);gl.bindBuffer(gl.ARRAY_BUFFER,deathVbo);gl.vertexAttribPointer(0,4,gl.FLOAT,false,0,0);gl.drawArrays(gl.TRIANGLE_STRIP,0,4);gl.disableVertexAttribArray(0);var b=256-((deathText.length/2)-0.5)*32;spriteAddText(b,400,32,deathText);deathDuration-=d}function playFrame(a){bgRenderPre();nodeRender();avatarFrame(a);aiFrame(a);bgRenderPost()};